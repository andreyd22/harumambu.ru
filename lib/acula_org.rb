#написан andreyd22  dmitrichev@gmail.com при пинках Паши Голубева golubev.pavel@gmail.com
require 'rubygems'
require 'hpricot'
require 'open-uri'
require File.dirname(__FILE__) + '/../lib/sequel_adapter.rb'


class AculaOrg
  
  CATEGORIES = {
  "Business Consulting" => 'Консалтинг',
  "Бизнес-планы" => 'Консалтинг',
  "Бухгалтерия" => 'Консалтинг',
  "Инвестиционные проекты" => 'Консалтинг',
  "Тренинги" => 'Консалтинг',
  "Управление персоналом" => 'Консалтинг',
  "Управление проектами" => 'Консалтинг',
  "Юриспруденция" => 'Консалтинг',
  "Web дизайн / Internet маркетинг / SEO" => 'Прочее',
  "Internet маркетинг" => 'Реклама/Маркетинг',
  "SEO" => 'Оптимизация (SEO)',
  "Верстка" => 'Дизайн',
  "Дизайн web сайтов" => 'Дизайн',
  "Дизайн баннеров" => 'Дизайн',
  "Контекстная реклама" => 'Реклама/Маркетинг',
  "Контент менеджер" => 'Тексты',
  "Флеш-сайты / флеш-графика" => 'Флеш',
  "Администрирование / Техподдержка" => 'Архитектура/Инжиниринг',
  "Администрирование серверов" => 'Архитектура/Инжиниринг',
  "Настройка аппаратного обеспечения" => 'Архитектура/Инжиниринг',
  "Техническая поддержка / Консультирование" => 'Консалтинг',
  "Установка ПО" => 'Архитектура/Инжиниринг',
  "Графический дизайн / презентации / мультимедиа" => 'Дизайн',
  "2D моделирование / 2D анимация" => 'Анимация/Мультипликация',
  "3D моделирование / 3D анимация" => '3D Графика',
  "Flash презентации" => 'Флеш',
  "Hаружная реклама" => 'Реклама/Маркетинг',
  "PowerPoint презентации" => 'Прочее',
  "Векторная графика" => 'Прочее',
  "Видео презентации" => 'Аудио/Видео',
  "Дизайн интерфейсов" => 'Дизайн',
  "Дизайн интерьеров" => 'Дизайн',
  "Дизайн упаковки" => 'Дизайн',
  "Иконки" => 'Дизайн',
  "Индустриальный дизайн" => 'Дизайн',
  "Комиксы" => 'Дизайн',
  "Ландшафтный дизайн" => 'Дизайн',
  "Логотипы" => 'Дизайн',
  "Полиграфическая верстка" => 'Полиграфия',
  "Полиграфия" => 'Полиграфия',
  "Разработка шрифтов" => 'Дизайн',
  "Ретуширование фотографий" => 'Фотография',
  "Фирменный стиль" => 'Дизайн',
  "Экстерьеры" => 'Дизайн',
  "Искусство" => 'Арт',
  "Графика" => 'Арт',
  "Живопись" => 'Арт',
  "Музыка" => 'Аудио/Видео',
  "Скульптура" => 'Арт',
  "Переводы / Тексты / Копирайтинг" => 'Тексты',
  "Web контент" => 'Тексты',
  "Документация" => 'Тексты',
  "Копирайтинг / Редактирование" => 'Тексты',
  "Новости / Статьи / Пресс-релизы" => 'Тексты',
  "Рекламные тексты" => 'Тексты',
  "Рефераты / Курсовые и Дипломные работы" => 'Тексты',
  "Стихи / проза" => 'Тексты',
  "Технические переводы" => 'Переводы',
  "Художественные переводы" => 'Переводы',
  "Программирование / Web пр. / ПО / Разработка БД" => 'Программирование',
  "1С-программирование" => 'Программирование',
  "PDA" => 'Программирование',
  "QA и тестирование ПО" => 'Прочее',
  "Web программирование" => 'Программирование',
  "Web-сайты &quot;под ключ&quot;" => 'Разработка сайтов',
  "Архитектура ПО" => 'Архитектура/Инжиниринг',
  "Встраиваемые системы" => 'Архитектура/Инжиниринг',
  "Другие технологии" => 'Прочее',
  "ПО для мобильных телефонов и КПК" => 'Программирование',
  "Прикладное программирование" => 'Программирование',
  "Разработка баз данных и администрирование" => 'Программирование',
  "Разработка игр" => 'Разработка игр',
  "Системное программирование" => 'Программирование',
  "Проектирование / CAD / Архитектура" => 'Архитектура/Инжиниринг',
  "CAD / AutoCad" => 'Архитектура/Инжиниринг',
  "Архитектура" => 'Архитектура/Инжиниринг',
  "Индустриальное проектирование" => 'Архитектура/Инжиниринг',
  "Реклама / Маркетинг / Обработка инф." => 'Реклама/Маркетинг',
  "Реклама / Маркетинг / Обработка инф." => 'Реклама/Маркетинг',
  "Branding" => 'Реклама/Маркетинг',
  "Product/Brand менеджмент" => 'Реклама/Маркетинг',
  "Public Relations Management (PR)" => 'Реклама/Маркетинг',
  "Маркетинговые и Консалтинговые исследования" => 'Реклама/Маркетинг',
  "Рекламные кампании" => 'Реклама/Маркетинг',
  "Сбор информации/Обработка информации" => 'Прочее',
  "Фотография" => 'Фотография',
  "Мероприятия / Репортажи" => 'Прочее',
  "Модели" => 'Прочее',
  "Ретуширование / Коллажи" => 'Дизайн',
  "Свадебные фото" => 'Фотография'
  }

  CURRENCIES = { 'RUB' => "руб.", "USD" => '$', 'EUR' => '€', "FM" => 'FM' }

  def self.desc
    'acula.org'
  end

  def self.latest
    self.rss
  end

  def self.rss
    doc = Hpricot.XML(open('http://acula.org/feed/newprojects.xml'))
    args = {}
    resultset = []
    (doc/:item).each do |project_div|
      args = {}
      args[:title] = convert((project_div/:title).inner_html)
      args[:url] = convert((project_div/:link).inner_html)
      args[:remote_id] = args[:url].gsub(/[^\d]/, '')
      desc = convert((project_div/:description).inner_html)
      desc2 =  desc.sub(/^(.+?)\n/i,"")
      args[:desc] = desc2.gsub(/&lt;/, '<').gsub(/&gt;/, '>').gsub(/\&\#xD\;/i,"")
      
      budjet = desc.match(/Максимальный бюджет\&lt\;\/strong\&gt\;\: (\d+) (EUR|USD|RUB)/i)[1]
      currency = desc.match(/Максимальный бюджет\&lt\;\/strong\&gt\;\: (\d+) (EUR|USD|RUB)/i)[2]
      begin
        category = convert((project_div/:category).inner_html)
        if CATEGORIES[category]
          args[:category_id] = DB["select id from categories where title ilike E'%#{CATEGORIES[category]}%'"].first[:id]

        end
      rescue Exception => e
        puts e

      end


      args[:created_at] = Time.now
      args[:budjet] = budjet
      args[:currency] = CURRENCIES[currency]
      if args[:budjet].to_f == 0.0
        args[:budjet] = nil
        args[:currency] = nil
      end

      resultset << args
    end
    resultset.reverse
  end

  def self.convert(s)
    s.force_encoding('UTF-8').to_s
  end
end
